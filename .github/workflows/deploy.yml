name: Deploy Node.js App to Azure VM

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build --if-present

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        script: |
          # Configure passwordless sudo for deployment user
          echo '${{ secrets.AZURE_VM_USERNAME }} ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/deploy-user
          sudo chmod 440 /etc/sudoers.d/deploy-user
          
          # Create app directory if it doesn't exist
          sudo mkdir -p /var/www/html/node-app
          sudo chown ${{ secrets.AZURE_VM_USERNAME }}:${{ secrets.AZURE_VM_USERNAME }} /var/www/html/node-app
          
          # Create logs directory
          sudo mkdir -p /var/log/node-app
          sudo chown ${{ secrets.AZURE_VM_USERNAME }}:${{ secrets.AZURE_VM_USERNAME }} /var/log/node-app

    - name: Copy files to Azure VM
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        source: ".,!.git,!.github,node_modules"
        target: "/var/www/html/node-app"

    - name: Setup and restart service on Azure VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        script: |
          cd /var/www/html/node-app
          
          # Install production dependencies
          npm ci --only=production
          
          # Create systemd service file
          sudo bash -c 'cat > /etc/systemd/system/node-app.service << EOF
          [Unit]
          Description=My Node.js Application
          After=network.target

          [Service]
          Type=simple
          User=${{ secrets.AZURE_VM_USERNAME }}
          WorkingDirectory=/var/www/html/node-app
          ExecStart=/usr/bin/node server.js
          Restart=on-failure
          RestartSec=10
          StandardOutput=file:/var/log/node-app/output.log
          StandardError=file:/var/log/node-app/error.log

          [Install]
          WantedBy=multi-user.target
          EOF'
          
          # Create environment file if needed
          sudo bash -c 'cat > /var/www/html/node-app/.env << EOF
          NODE_ENV=production
          PORT=3000
          EOF'
          
          # Set proper permissions
          sudo chmod 644 /etc/systemd/system/node-app.service
          sudo chown ${{ secrets.AZURE_VM_USERNAME }}:${{ secrets.AZURE_VM_USERNAME }} /var/www/html/node-app/.env
          
          # Reload systemd and enable the service
          sudo systemctl daemon-reload
          sudo systemctl enable node-app.service
          
          # Restart the service
          sudo systemctl restart node-app.service
          
          # Check service status
          sudo systemctl status node-app.service
          
