name: Deploy to Staging and Production

on:
  push:
    branches: [ dev, main ]

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show deployment info
      run: |
        echo "üéØ Deploying to STAGING environment"
        echo "üåø Branch: ${{ github.ref }}"
        echo "üè∑Ô∏è  Commit: ${{ github.sha }}"

    - name: Deploy to Staging Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PUBLIC_KEY }}
        script: |
          set -e  # Exit on error
          
          echo "üöÄ Starting deployment to STAGING..."
          
          # Create backup with timestamp
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          sudo cp -r /var/www/html /var/www/html.backup.staging.$TIMESTAMP 2>/dev/null || true
          
          # Remove existing content and deploy new files
          sudo rm -rf /var/www/html/*
          sudo mkdir -p /var/www/html
          sudo cp -r frontend/* /var/www/html/
          
          # Set proper permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Create deployment info file
          echo "Environment: staging" | sudo tee /var/www/html/deployment-info.txt
          echo "Branch: ${{ github.ref }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Commit: ${{ github.sha }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Deployed at: $(date)" | sudo tee -a /var/www/html/deployment-info.txt
          
          # Test and reload nginx
          sudo nginx -t
          sudo systemctl reload nginx
          
          echo "‚úÖ Staging deployment completed successfully!"
          echo "üìÅ Backup created: /var/www/html.backup.staging.$TIMESTAMP"

    - name: Verify Staging Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PUBLIC_KEY }}
        script: |
          # Verify nginx is running
          if systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx is running on staging"
          else
            echo "‚ùå Nginx is not running on staging"
            exit 1
          fi
          
          # Verify files are deployed
          if [ -n "$(ls -A /var/www/html/)" ]; then
            echo "‚úÖ Files are deployed successfully to staging"
            echo "üìÑ Deployment info:"
            cat /var/www/html/deployment-info.txt || echo "No deployment info file"
          else
            echo "‚ùå No files found in /var/www/html/ on staging"
            exit 1
          fi

  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show deployment info
      run: |
        echo "üéØ Deploying to PRODUCTION environment"
        echo "üåø Branch: ${{ github.ref }}"
        echo "üè∑Ô∏è  Commit: ${{ github.sha }}"
        echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT - BE CAREFUL!"

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PUBLIC_KEY }}
        script: |
          set -e  # Exit on error
          
          echo "üöÄ Starting deployment to PRODUCTION..."
          echo "‚ö†Ô∏è  This is PRODUCTION - be careful!"
          
          # Create backup with timestamp (important for production)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          sudo cp -r /var/www/html /var/www/html.backup.production.$TIMESTAMP 2>/dev/null || true
          echo "üìÅ Production backup created: /var/www/html.backup.production.$TIMESTAMP"
          
          # Remove existing content and deploy new files
          sudo rm -rf /var/www/html/*
          sudo mkdir -p /var/www/html
          sudo cp -r frontend/index/* /var/www/html/
          
          # Set proper permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Create deployment info file
          echo "Environment: production" | sudo tee /var/www/html/deployment-info.txt
          echo "Branch: ${{ github.ref }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Commit: ${{ github.sha }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Deployed at: $(date)" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Backup: /var/www/html.backup.production.$TIMESTAMP" | sudo tee -a /var/www/html/deployment-info.txt
          
          # Test and reload nginx
          sudo nginx -t
          sudo systemctl reload nginx
          
          echo "‚úÖ Production deployment completed successfully!"
          echo "üéâ Production is now live with the latest changes!"

    - name: Verify Production Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PUBLIC_KEY }}
        script: |
          # Verify nginx is running
          if systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx is running on production"
          else
            echo "‚ùå Nginx is not running on production"
            exit 1
          fi
          
          # Verify files are deployed
          if [ -n "$(ls -A /var/www/html/)" ]; then
            echo "‚úÖ Files are deployed successfully to production"
            echo "üìÑ Deployment info:"
            cat /var/www/html/deployment-info.txt || echo "No deployment info file"
          else
            echo "‚ùå No files found in /var/www/html/ on production"
            exit 1
          fi
